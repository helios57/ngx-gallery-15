name: Dependabot Angular Migration

on:
  pull_request:
    branches: [ main, master, 'bugfix/v*' ]

permissions:
  contents: write
  pull-requests: write

jobs:
  migrate:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Check for Angular Update
        id: check_angular
        run: |
          # Check if @angular, zone.js or typescript is being updated in the package.json
          # These are excluded from the general auto-merge workflow to ensure migrations run

          # Get the diff of package.json compared to the base branch
          # We look for lines starting with + and containing our target packages
          if git diff origin/${{ github.base_ref }}..HEAD package.json | grep -E "^\+" | grep -qiE "@angular|zone\.js|typescript"; then
            echo "angular_update=true" >> $GITHUB_OUTPUT
          else
            echo "angular_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Angular Migration
        if: steps.check_angular.outputs.angular_update == 'true'
        run: |
          # Dependabot already updated package.json, but didn't run migrations.
          # To run migrations, we revert package.json/lock to the base branch state,
          # then run 'ng update' to apply the same update Dependabot wanted, but with migrations.

          # Get the target version from the current package.json (updated by Dependabot)
          TARGET_CORE_VERSION=$(node -p "require('./package.json').dependencies['@angular/core']")
          CLI_VERSION=$(node -p "require('./package.json').devDependencies['@angular/cli'] || require('./package.json').dependencies['@angular/cli']")
          NG_PACKAGR_VERSION=$(node -p "require('./package.json').devDependencies['ng-packagr'] || require('./package.json').dependencies['ng-packagr']")
          ZONEJS_VERSION=$(node -p "require('./package.json').dependencies['zone.js']")
          TYPESCRIPT_VERSION=$(node -p "require('./package.json').devDependencies['typescript']")

          if [ -z "$CLI_VERSION" ] || [ "$CLI_VERSION" == "undefined" ]; then
            CLI_VERSION=$TARGET_CORE_VERSION
          fi

          # Get the current version from the base branch
          git checkout origin/${{ github.base_ref }} package.json
          CURRENT_CORE_VERSION=$(node -p "require('./package.json').dependencies['@angular/core']")

          # Re-apply the changes to package.json (back to Dependabot's version)
          git checkout HEAD package.json

          # Extract major versions
          CURRENT_MAJOR=$(echo $CURRENT_CORE_VERSION | sed 's/[^0-9.]//g' | cut -d. -f1)
          TARGET_MAJOR=$(echo $TARGET_CORE_VERSION | sed 's/[^0-9.]//g' | cut -d. -f1)

          echo "Current Angular Major: $CURRENT_MAJOR (@angular/core@$CURRENT_CORE_VERSION)"
          echo "Target Angular Major: $TARGET_MAJOR (@angular/core@$TARGET_CORE_VERSION)"

          # Validate that we are only upgrading one major version at a time
          if [ "$TARGET_MAJOR" -gt "$((CURRENT_MAJOR + 1))" ]; then
            echo "::error::Attempting to upgrade from Angular $CURRENT_MAJOR to $TARGET_MAJOR. Angular migrations MUST be run for every major version. Please upgrade to Angular $((CURRENT_MAJOR + 1)) first."
            exit 1
          fi

          # Function to sync a package to the target major if it's ahead
          sync_version() {
            local version=$1
            local target_major=$2
            if [ ! -z "$version" ] && [ "$version" != "undefined" ]; then
              local major=$(echo $version | sed 's/[^0-9.]//g' | cut -d. -f1)
              if [ "$major" -gt "$target_major" ]; then
                echo "$major is ahead of $target_major. Syncing to @$target_major."
                echo "$target_major"
              else
                echo "$version"
              fi
            else
              echo ""
            fi
          }

          NG_PACKAGR_VERSION=$(sync_version "$NG_PACKAGR_VERSION" "$TARGET_MAJOR")
          ZONEJS_VERSION=$(sync_version "$ZONEJS_VERSION" "$TARGET_MAJOR")

          # TypeScript has complex compatibility, but usually follows major trends or is strictly capped
          # For now, let's keep it if it's not obviously breaking.
          # But let's at least include it in ng update if present.

          UPDATE_CMD="@angular/core@$TARGET_CORE_VERSION @angular/cli@$CLI_VERSION"
          [ ! -z "$NG_PACKAGR_VERSION" ] && UPDATE_CMD="$UPDATE_CMD ng-packagr@$NG_PACKAGR_VERSION"
          [ ! -z "$ZONEJS_VERSION" ] && UPDATE_CMD="$UPDATE_CMD zone.js@$ZONEJS_VERSION"
          [ ! -z "$TYPESCRIPT_VERSION" ] && [ "$TYPESCRIPT_VERSION" != "undefined" ] && UPDATE_CMD="$UPDATE_CMD typescript@$TYPESCRIPT_VERSION"

          echo "Targeting $UPDATE_CMD"

          # Revert to base branch state for migration execution
          git checkout origin/${{ github.base_ref }} package.json package-lock.json

          # Install old dependencies to ensure ng update works correctly
          npm install --legacy-peer-deps

          # Run ng update to the target versions. This will run migrations.
          # We use --allow-dirty because we just changed package.json
          npx ng update $UPDATE_CMD --allow-dirty --force

      - name: Update Library Version and Create Bugfix Branch on Major Angular Upgrade
        id: update_version
        if: steps.check_angular.outputs.angular_update == 'true'
        run: |
          # Get the new Angular major version
          NEW_MAJOR_VERSION=$(node -p "require('./package.json').dependencies['@angular/core'].replace(/[^0-9.]/g, '').split('.')[0]")

          # Get the current library version from the base branch (main/master)
          git checkout origin/${{ github.base_ref }} package.json
          OLD_LIB_VERSION=$(node -p "require('./package.json').version")
          OLD_MAJOR_LIB_VERSION=$(echo $OLD_LIB_VERSION | cut -d. -f1)

          # Re-apply the changes to package.json (from the ng update)
          git checkout HEAD package.json

          echo "Angular New Major: $NEW_MAJOR_VERSION"
          echo "Library Old Major: $OLD_MAJOR_LIB_VERSION"

          if [ "$NEW_MAJOR_VERSION" -gt "$OLD_MAJOR_LIB_VERSION" ]; then
            NEW_LIB_VERSION="$NEW_MAJOR_VERSION.0.0"
            echo "Major version upgrade detected. Updating library to $NEW_LIB_VERSION"

            # 1. Create bugfix branch for the OLD major version before we update main
            # We create it from the base branch (main/master)
            BUGFIX_BRANCH="bugfix/v$OLD_MAJOR_LIB_VERSION.x"

            # Check if branch exists on remote
            if git ls-remote --exit-code --heads origin $BUGFIX_BRANCH; then
              echo "Bugfix branch $BUGFIX_BRANCH already exists."
            else
              echo "Creating new bugfix branch $BUGFIX_BRANCH from ${{ github.base_ref }}"
              # We need to be careful with the token here if we want to push
              git push origin origin/${{ github.base_ref }}:refs/heads/$BUGFIX_BRANCH
            fi

            # 2. Update dependabot.yml on the base branch to include the new bugfix branch
            # We temporarily checkout the base branch to update it
            git checkout origin/${{ github.base_ref }} .github/dependabot.yml

            if grep -q "target-branch: \"$BUGFIX_BRANCH\"" .github/dependabot.yml; then
              echo "Bugfix branch $BUGFIX_BRANCH already configured in dependabot.yml"
            else
              echo "Adding $BUGFIX_BRANCH to dependabot.yml"
              # Ensure there is a newline before appending
              [ -n "$(tail -c1 .github/dependabot.yml)" ] && echo "" >> .github/dependabot.yml

              # Append the new bugfix branch configuration to dependabot.yml
              echo "  - package-ecosystem: \"npm\"" >> .github/dependabot.yml
              echo "    directory: \"/\"" >> .github/dependabot.yml
              echo "    target-branch: \"$BUGFIX_BRANCH\"" >> .github/dependabot.yml
              echo "    schedule:" >> .github/dependabot.yml
              echo "      interval: \"daily\"" >> .github/dependabot.yml
              echo "    open-pull-requests-limit: 10" >> .github/dependabot.yml
              echo "    groups:" >> .github/dependabot.yml
              echo "      angular:" >> .github/dependabot.yml
              echo "        patterns:" >> .github/dependabot.yml
              echo "          - \"@angular/*\"" >> .github/dependabot.yml
              echo "          - \"zone.js\"" >> .github/dependabot.yml
              echo "          - \"rxjs\"" >> .github/dependabot.yml
              echo "          - \"tslib\"" >> .github/dependabot.yml
              echo "          - \"typescript\"" >> .github/dependabot.yml

              # We will commit this change to the current PR branch so it gets merged into main
              git add .github/dependabot.yml
            fi

            # 3. Update root package.json for the NEW major version
            npm version $NEW_LIB_VERSION --no-git-tag-version

            # 4. Update project package.json
            if [ -f "projects/ngx-gallery/package.json" ]; then
              cd projects/ngx-gallery
              npm pkg set version=$NEW_LIB_VERSION

              # Also sync peerDependencies to the new major
              npm pkg set peerDependencies."@angular/common"="~$NEW_MAJOR_VERSION.0.0"
              npm pkg set peerDependencies."@angular/core"="~$NEW_MAJOR_VERSION.0.0"

              cd ../..
            fi
            echo "version_bumped=true" >> $GITHUB_OUTPUT
          else
            echo "No major version upgrade detected or Angular version is not greater than library version."
            echo "version_bumped=false" >> $GITHUB_OUTPUT
          fi

      - name: Bump patch version for minor/patch Angular update
        if: steps.check_angular.outputs.angular_update == 'true' && steps.update_version.outputs.version_bumped != 'true'
        run: |
          # Increment patch version
          npm version patch --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")

          if [ -f "projects/ngx-gallery/package.json" ]; then
            cd projects/ngx-gallery
            npm pkg set version=$NEW_VERSION
            cd ../..
          fi

      - name: Commit migration changes
        if: steps.check_angular.outputs.angular_update == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore: apply angular migrations and bump version"
          file_pattern: "."

      - name: Enable auto-merge for this PR
        if: steps.check_angular.outputs.angular_update == 'true'
        run: |
          echo "Waiting for GitHub to process the commit..."
          sleep 10
          # We use a retry loop because GitHub's API can be inconsistent right after a push
          for i in {1..5}; do
            echo "Attempt $i: Enabling auto-merge..."
            gh pr merge --auto --rebase "$PR_URL" && break || {
              echo "Attempt $i failed. Waiting before retry..."
              sleep 15
            }
          done
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
