name: Dependabot Auto-Merge

on:
  workflow_run:
    workflows: ["CI/CD"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Bump version and merge
        env:
          PR_JSON: ${{ toJSON(github.event.workflow_run.pull_requests) }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # In workflow_run, we need to find the PR number.
          # The event contains a list of pull_requests.
          PR_NUMBER=$(node -e "const prs = JSON.parse(process.env.PR_JSON); console.log(prs[0]?.number)")

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" == "undefined" ]; then
            echo "No PR number found"
            exit 0
          fi

          TITLE=$(gh pr view "$PR_NUMBER" --json title --template '{{.title}}')
          if [[ ! "$TITLE" =~ "@angular" ]] && [[ ! "$TITLE" =~ "zone.js" ]] && [[ ! "$TITLE" =~ "typescript" ]]; then
            # Checkout the PR branch
            gh pr checkout "$PR_NUMBER"

            # Check if the last commit is already a version bump to avoid infinite loop
            LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
            if [[ "$LAST_COMMIT_MSG" =~ "chore: bump version" ]]; then
              echo "Version already bumped, proceeding to merge"
            else
              echo "Bumping patch version"
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

              npm version patch --no-git-tag-version
              NEW_VERSION=$(node -p "require('./package.json').version")

              if [ -f "projects/ngx-gallery/package.json" ]; then
                cd projects/ngx-gallery
                npm pkg set version=$NEW_VERSION
                cd ../..
                git add projects/ngx-gallery/package.json
              fi

              git add package.json package-lock.json
              git commit -m "chore: bump version to $NEW_VERSION"
              git push origin HEAD

              echo "Version bumped to $NEW_VERSION and pushed. Waiting for next CI run to merge."
            fi

            echo "Waiting for GitHub to process the state..."
            sleep 5
            for i in {1..5}; do
              echo "Attempt $i: Enabling auto-merge..."
              gh pr merge --auto --rebase "$PR_NUMBER" && break || {
                echo "Attempt $i failed. Waiting before retry..."
                sleep 15
              }
            done
          else
            echo "Skipping auto-merge for Angular/Zone.js/TypeScript update"
          fi
